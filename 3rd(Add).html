<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>MediCare — Light Theme Prototype (v2)</title>
<style>
:root{
  --primary:#1e88e5;
  --primary-light:#64b5f6;
  --bg:#f8fafc;
  --card:#ffffff;
  --text:#1a1a1a;
  --muted:#555;
  --border:#e6edf3;
}
*{box-sizing:border-box;font-family:Arial,Helvetica,sans-serif;}
body{margin:0;background:var(--bg);color:var(--text);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;}
.container{width:1100px;max-width:100%;display:grid;grid-template-columns:360px 1fr;gap:20px;}
.card{background:var(--card);padding:18px;border-radius:12px;border:1px solid var(--border);box-shadow:0 6px 18px rgba(15,23,42,0.06);}
.brand{display:flex;gap:12px;align-items:center;margin-bottom:10px;}
.logo{width:44px;height:44px;border-radius:10px;background:var(--primary);color:white;font-weight:700;display:flex;align-items:center;justify-content:center;font-size:18px;}
h1,h2,h3,h4{margin:8px 0;color:var(--text);}
small{color:var(--muted);}
.label{font-size:14px;margin:8px 0 6px;display:block;}
.input, select, textarea{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);font-size:14px;}
.btn{padding:10px 14px;border-radius:8px;background:var(--primary);border:none;color:white;font-weight:600;cursor:pointer;transition:0.15s;}
.btn:hover{background:#156cc3;}
.link{background:none;border:none;color:var(--primary);cursor:pointer;padding:6px 0;font-size:14px;}
.nav{display:flex;gap:8px;flex-wrap:wrap;margin-top:6px;}
.hr{height:1px;background:var(--border);margin:14px 0;border-radius:6px;}
.small-muted{font-size:13px;color:var(--muted);}
.row{display:flex;gap:8px;align-items:center;}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
.badge{padding:6px 10px;border-radius:20px;background:var(--primary-light);font-size:13px;color:#fff;}
.table{width:100%;border-collapse:collapse;font-size:14px;}
.table th,.table td{padding:10px;border-bottom:1px solid var(--border);text-align:left;}
.avatar{width:38px;height:38px;border-radius:10px;background:var(--primary-light);color:#fff;font-weight:700;display:flex;align-items:center;justify-content:center;}
.chat-box{height:260px;overflow:auto;padding:10px;background:#f1f4f7;border-radius:8px;border:1px solid var(--border);}
.code{font-family:monospace;background:#eef2f7;padding:6px;border-radius:6px;font-size:13px;display:inline-block;}
.toast{position:fixed;right:20px;bottom:20px;background:#333;color:#fff;padding:12px 16px;border-radius:8px;box-shadow:0 4px 20px rgba(0,0,0,0.2);font-size:14px;}
.hidden{display:none;}
.form-note{font-size:13px;color:var(--muted);margin-top:6px;}
.error{color:#b00020;font-size:13px;margin-top:6px;}
</style>
</head>
<body>
<div class="container">
  <div class="card" id="leftPanel">
    <div class="brand">
      <div class="logo">MC</div>
      <div><h2>MediCare</h2><small>Light & user-friendly (v2)</small></div>
    </div>

    <div id="authArea">
      <!-- Signup -->
      <div id="signupBox">
        <h3>Create Account</h3>
        <label class="label">Full name</label><input id="su_name" class="input" placeholder="First Last" />
        <label class="label">Email</label><input id="su_email" class="input" type="email" placeholder="you@example.com" />
        <label class="label">Password</label><input id="su_pass" class="input" type="password" placeholder="min 8 characters" />
        <label class="label">Confirm Password</label><input id="su_pass2" class="input" type="password" />
        <label class="label">Role</label>
        <select id="su_role" class="input">
          <option value="">-- select role --</option>
          <option value="patient">Patient</option>
          <option value="doctor">Doctor</option>
          <option value="admin">Admin</option>
        </select>
        <div id="signupError" class="error hidden"></div>
        <div class="row" style="margin-top:12px">
          <button class="btn" id="signupBtn">Sign Up</button>
          <button class="link" id="toSignin">Already have an account?</button>
        </div>
        <div class="hr"></div>
      </div>

      <!-- Signin -->
      <div id="signinBox" class="hidden">
        <h3>Sign In</h3>
        <label class="label">Email</label><input id="si_email" class="input" type="email" />
        <label class="label">Password</label><input id="si_pass" class="input" type="password" />
        <div id="signinError" class="error hidden"></div>
        <div class="row" style="margin-top:12px">
          <button class="btn" id="signinBtn">Sign In</button>
          <button class="link" id="toSignup">Create Account</button>
        </div>
        <button class="link" id="toForgot">Forgot Password?</button>
        <div class="hr"></div>
      </div>

      <!-- Forgot -->
      <div id="forgotBox" class="hidden">
        <h3>Reset Password</h3>
        <label class="label">Enter your email</label><input id="fg_email" class="input" type="email" />
        <div id="fgError" class="error hidden"></div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="sendCodeBtn">Send Code</button>
          <button class="link" id="fg_back">Back</button>
        </div>
        <div class="hr"></div>
      </div>

      <!-- Reset -->
      <div id="resetBox" class="hidden">
        <h3>Enter New Password</h3>
        <label class="label">Verification Code</label><input id="rc_code" class="input" />
        <label class="label">New Password</label><input id="rc_pass" class="input" type="password" />
        <label class="label">Confirm New Password</label><input id="rc_pass2" class="input" type="password" />
        <div id="rcError" class="error hidden"></div>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="resetBtn">Reset Password</button>
          <button class="link" id="reset_cancel">Cancel</button>
        </div>
        <div class="hr"></div>
      </div>

      <!-- Logged-in -->
      <div id="loggedBox" class="hidden">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div class="row" style="align-items:center">
            <div class="avatar" id="userAvatar">U</div>
            <div style="margin-left:8px">
              <div id="userName"></div>
              <small id="userRole" class="small-muted"></small>
            </div>
          </div>
          <div class="row">
            <button class="link" id="openAudit">Audit</button>
            <button class="btn" id="logoutBtn">Logout</button>
          </div>
        </div>
        <div class="hr"></div>
        <h4>Quick Actions</h4>
        <div class="row">
          <button class="btn" id="goDashboard">Dashboard</button>
          <button class="link" id="goChat">AI Chat</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Right Panel -->
  <div class="card">
    <div id="mainArea">
      <h2>Welcome to MediCare</h2>
      <p class="small-muted">Functional client-side demo. Validation, role restrictions, and improved chat replies added.</p>

      <!-- Dashboard -->
      <div id="dashboard" class="hidden">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <h3 id="dashTitle"></h3>
            <div class="small-muted" id="dashWelcome"></div>
          </div>
          <div class="row">
            <div class="badge" id="dashBadge"></div>
          </div>
        </div>
        <div id="dashContent" style="margin-top:14px"></div>
      </div>

      <!-- Audit -->
      <div id="auditArea" class="hidden">
        <h3>Audit Logs</h3>
        <table class="table" id="auditTable">
          <thead><tr><th>Time</th><th>User</th><th>Action</th></tr></thead><tbody></tbody>
        </table>
        <div class="row" style="margin-top:10px">
          <button class="btn" id="closeAudit">Close</button>
          <button class="link hidden" id="exportAudit">Export JSON</button>
        </div>
      </div>

      <!-- Chat -->
      <div id="chatArea" class="hidden">
        <h3>AI Chat (Demo)</h3>
        <div class="chat-box" id="chatBox"></div>
        <div class="row" style="margin-top:8px">
          <input id="chatInput" class="input" placeholder="Ask a medical-related question or use quick actions" />
          <button class="btn" id="chatSend">Send</button>
        </div>
        <div class="form-note">Quick actions: type <code>book appointment</code>, <code>doctor info</code>, <code>request ambulance</code>, or <code>faq</code>.</div>
      </div>

    </div>
  </div>
</div>

<div id="toast" class="toast hidden"></div>

<script>
function toast(msg,t=3500){const e=document.getElementById('toast');e.textContent=msg;e.classList.remove('hidden');setTimeout(()=>e.classList.add('hidden'),t)}
function now(){return new Date().toISOString()}
function load(k,def=[]){try{const v=localStorage.getItem(k);return v?JSON.parse(v):def}catch{return def}}
function save(k,v){localStorage.setItem(k,JSON.stringify(v))}
function hash(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0}return h.toString()}
function addAudit(user,action){const a=load('mc_audit',[]);a.unshift({when:now(),user:user||'anon',action});save('mc_audit',a)}

const emailRe = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
function validEmail(e){return emailRe.test(e);}
function validFullName(n){ if(!n) return false; const parts=n.trim().split(/\s+/); return parts.length>=2 && parts.every(p=>/^[A-Za-z'-]+$/.test(p)); }
function validPassword(p){ return typeof p==='string' && p.length>=8; }

// Seed demo
function ensureSeed(){
  const users=load('mc_users',[]);
  if(!users.length){
    users.push({name:'Admin',email:'admin@local',role:'admin',pass:hash('admin123')});
    users.push({name:'Dr. Lee',email:'lee@local',role:'doctor',pass:hash('doctor123')});
    users.push({name:'John Doe',email:'john@local',role:'patient',pass:hash('patient123')});
    save('mc_users',users); addAudit('system','seeded demo users');
  }
}
ensureSeed();

function getSession(){try{return JSON.parse(localStorage.getItem('mc_sess')||'null')}catch{return null}}
function setSession(s){localStorage.setItem('mc_sess',JSON.stringify(s))}
function clearSession(){localStorage.removeItem('mc_sess')}

const signupBox=document.getElementById('signupBox'), signinBox=document.getElementById('signinBox'), forgotBox=document.getElementById('forgotBox'), resetBox=document.getElementById('resetBox'), loggedBox=document.getElementById('loggedBox');
const dashboard=document.getElementById('dashboard'), dashContent=document.getElementById('dashContent'), dashTitle=document.getElementById('dashTitle'), dashWelcome=document.getElementById('dashWelcome'), dashBadge=document.getElementById('dashBadge');
const auditArea=document.getElementById('auditArea'), exportAuditBtn=document.getElementById('exportAudit');

document.getElementById('toSignin').onclick = ()=>{ signupBox.classList.add('hidden'); signinBox.classList.remove('hidden'); };
document.getElementById('toSignup').onclick = ()=>{ signinBox.classList.add('hidden'); signupBox.classList.remove('hidden'); };
document.getElementById('toForgot').onclick = ()=>{ signinBox.classList.add('hidden'); forgotBox.classList.remove('hidden'); };
document.getElementById('fg_back').onclick = ()=>{ forgotBox.classList.add('hidden'); signinBox.classList.remove('hidden'); };
document.getElementById('reset_cancel').onclick = ()=>{ resetBox.classList.add('hidden'); signinBox.classList.remove('hidden'); };

function updateAuthUI(){
  const s = getSession();
  if(!s){
    loggedBox.classList.add('hidden');
    signupBox.classList.remove('hidden');
    signinBox.classList.add('hidden');
    document.getElementById('openAudit').classList.add('hidden');
    return;
  }
  document.getElementById('userName').textContent = s.name;
  document.getElementById('userRole').textContent = s.role;
  document.getElementById('userAvatar').textContent = s.name.split(' ').map(x=>x[0]).slice(0,2).join('');
  signupBox.classList.add('hidden'); signinBox.classList.add('hidden');
  forgotBox.classList.add('hidden'); resetBox.classList.add('hidden');
  loggedBox.classList.remove('hidden');

  if(s.role === 'patient'){
    document.getElementById('openAudit').classList.add('hidden');
    exportAuditBtn.classList.add('hidden');
  } else {
    document.getElementById('openAudit').classList.remove('hidden');
    exportAuditBtn.classList.remove('hidden');
  }
}
updateAuthUI();

// =========================
// SIGNUP (USERNAME UNIQUE)
// =========================
document.getElementById('signupBtn').onclick = ()=>{
  const name = document.getElementById('su_name').value.trim();
  const email = document.getElementById('su_email').value.trim().toLowerCase();
  const pass = document.getElementById('su_pass').value;
  const pass2 = document.getElementById('su_pass2').value;
  const role = document.getElementById('su_role').value;
  const errEl = document.getElementById('signupError');

  errEl.classList.add('hidden');
  errEl.textContent = '';

  if(!validFullName(name)){ errEl.textContent='Enter full name (first & last).'; errEl.classList.remove('hidden'); return; }
  if(!validEmail(email)){ errEl.textContent='Enter valid email.'; errEl.classList.remove('hidden'); return; }
  if(!validPassword(pass)){ errEl.textContent='Password must be ≥ 8 chars.'; errEl.classList.remove('hidden'); return; }
  if(pass !== pass2){ errEl.textContent='Passwords do not match.'; errEl.classList.remove('hidden'); return; }
  if(!role){ errEl.textContent='Select a role.'; errEl.classList.remove('hidden'); return; }

  const users = load('mc_users',[]);

  // ⭐ NEW MINOR CHANGE: USERNAME MUST BE UNIQUE
  if(users.find(u=>u.name.toLowerCase() === name.toLowerCase())){
    errEl.textContent = 'Username already taken — choose another';
    errEl.classList.remove('hidden');
    return;
  }

  if(users.find(u=>u.email === email)){
    errEl.textContent='Email already registered.';
    errEl.classList.remove('hidden');
    return;
  }

  users.push({name,email,role,pass:hash(pass),created:now()});
  save('mc_users',users);

  setSession({name,email,role});
  addAudit(email,'signup ('+role+')');
  updateAuthUI();
  toast('Signup successful — logged in');
  renderDashboard();
};

document.getElementById('signinBtn').onclick = ()=>{
  const email = document.getElementById('si_email').value.trim().toLowerCase();
  const pass = document.getElementById('si_pass').value;
  const err=document.getElementById('signinError');
  err.classList.add('hidden'); err.textContent='';
  if(!validEmail(email)){ err.textContent='Enter valid email'; err.classList.remove('hidden'); return; }
  const users=load('mc_users',[]);
  const u = users.find(x=>x.email===email && x.pass===hash(pass));
  if(!u){ err.textContent='Invalid credentials'; err.classList.remove('hidden'); addAudit(email,'failed signin'); return; }
  setSession({name:u.name,email:u.email,role:u.role});
  addAudit(u.email,'signin');
  updateAuthUI();
  toast('Signed in');
  renderDashboard();
};

document.getElementById('logoutBtn').onclick = ()=>{
  const s=getSession();
  clearSession();
  updateAuthUI();
  dashboard.classList.add('hidden');
  document.getElementById('mainArea').classList.remove('hidden');
  addAudit(s?.email,'logout');
  toast('Logged out');
};

// Remaining logic unchanged (forgot, reset, dashboard, doctor, patient, chat)

function renderDashboard(){
  const s=getSession(); if(!s){ toast('Please sign in');return; }
  dashboard.classList.remove('hidden');
  document.getElementById('mainArea').classList.remove('hidden');
  dashTitle.textContent=s.role.charAt(0).toUpperCase()+s.role.slice(1)+' Dashboard';
  dashWelcome.textContent='Welcome, '+s.name.split(' ')[0];
  dashBadge.textContent=s.role.toUpperCase();
  dashContent.innerHTML='';
  addAudit(s.email,'viewed dashboard');
  if(s.role==='admin') renderAdmin();
  if(s.role==='doctor') renderDoctor();
  if(s.role==='patient') renderPatient();
}

// Admin, doctor, patient, audit, chat functions unchanged
// (Omitted for brevity—they remain EXACTLY as in your original file)

</script>
</body>
</html>
